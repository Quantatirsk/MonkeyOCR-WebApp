# MonkeyOCR WebApp - 数据持久化改进方案

## 项目概述
解决页面刷新后任务列表丢失的问题，实现前后端协同的完整数据持久化方案。

**核心理念**: 服务器为真实数据源 + 客户端智能缓存 + 状态同步机制

---

## Phase 1: 后端持久化基础设施
**优先级**: Critical  
**预估时间**: 12-16 小时  
**状态**: 待开始

### P1-T001: 数据持久化模块开发
**描述**: 创建文件系统持久化模块替代内存存储  
**优先级**: Critical  
**预估时间**: 4 小时  
**依赖**: 无

**子任务**:
- [ ] 创建 `backend/utils/persistence.py` 持久化工具类
- [ ] 实现任务状态的 JSON 文件读写
- [ ] 添加数据完整性验证和错误恢复
- [ ] 创建 `backend/data/` 目录和 `tasks.json` 初始化

**验收标准**:
- 任务状态能够完整保存到文件
- 服务器重启后能正确加载任务状态
- 包含数据校验和错误处理机制

### P1-T002: 任务存储重构
**描述**: 将内存字典存储替换为持久化存储  
**优先级**: Critical  
**预估时间**: 3 小时  
**依赖**: P1-T001

**子任务**:
- [ ] 修改 `backend/api/upload.py` 中的 `tasks_storage`
- [ ] 重构任务 CRUD 操作使用持久化模块
- [ ] 更新任务状态更新逻辑
- [ ] 添加任务数据同步锁机制

**验收标准**:
- 所有任务操作都能持久化到文件
- 并发访问安全
- 保持现有 API 接口不变

### P1-T003: 文件管理系统优化
**描述**: 改进文件存储和管理策略  
**优先级**: High  
**预估时间**: 3 小时  
**依赖**: P1-T002

**子任务**:
- [ ] 创建任务专用目录结构 `uploads/{task_id}/`
- [ ] 实现原始文件保留机制
- [ ] 优化 `backend/utils/file_handler.py` 文件组织
- [ ] 添加文件清理和垃圾回收机制

**验收标准**:
- 每个任务的文件都有独立目录
- 原始文件能够长期保存
- 文件清理机制正常工作

### P1-T004: 服务器重启恢复机制
**描述**: 实现服务器重启后的任务状态恢复  
**优先级**: High  
**预估时间**: 2-3 小时  
**依赖**: P1-T002

**子任务**:
- [ ] 在 `backend/main.py` 添加启动时数据加载
- [ ] 实现处理中任务的状态检查和恢复
- [ ] 重新启动未完成任务的后台监控
- [ ] 添加数据迁移和版本兼容性处理

**验收标准**:
- 服务器重启后所有任务状态正确恢复
- 处理中的任务能继续监控
- 数据版本兼容性良好

---

## Phase 2: API 扩展和文件服务
**优先级**: High  
**预估时间**: 8-10 小时  
**状态**: 待开始

### P2-T001: 状态同步 API 开发
**描述**: 新增前端状态同步所需的 API 端点  
**优先级**: Critical  
**预估时间**: 3 小时  
**依赖**: P1-T002

**子任务**:
- [ ] 创建 `GET /api/sync` 端点获取所有任务状态
- [ ] 添加任务状态差异对比功能
- [ ] 实现增量同步机制
- [ ] 添加同步时间戳和版本控制

**验收标准**:
- 能够获取完整的任务状态列表
- 支持增量和全量同步
- 包含适当的缓存控制

### P2-T002: 文件预览 API 开发
**描述**: 提供原始文件预览和访问 API  
**优先级**: High  
**预估时间**: 2-3 小时  
**依赖**: P1-T003

**子任务**:
- [ ] 创建 `GET /api/files/{task_id}/original` 原始文件访问
- [ ] 创建 `GET /api/tasks/{task_id}/preview` 预览信息获取
- [ ] 添加文件访问权限和安全检查
- [ ] 实现文件 MIME 类型正确识别

**验收标准**:
- 能够安全访问任务的原始文件
- 支持图片和 PDF 文件预览
- 包含适当的安全控制

### P2-T003: 任务元数据增强
**描述**: 扩展任务数据结构支持持久化需求  
**优先级**: Medium  
**预估时间**: 2 小时  
**依赖**: P1-T001

**子任务**:
- [ ] 扩展 `ProcessingTask` 模型添加持久化字段
- [ ] 添加文件哈希和校验信息
- [ ] 实现任务状态变更历史记录
- [ ] 优化任务查询和过滤功能

**验收标准**:
- 任务数据结构支持完整的持久化
- 数据完整性验证机制
- 高效的查询和过滤能力

### P2-T004: 性能优化和缓存
**描述**: 优化 API 性能和添加缓存机制  
**优先级**: Medium  
**预估时间**: 1-2 小时  
**依赖**: P2-T001, P2-T002

**子任务**:
- [ ] 实现任务状态查询缓存
- [ ] 添加文件访问缓存控制
- [ ] 优化大量任务时的查询性能
- [ ] 实现 API 响应压缩

**验收标准**:
- API 响应时间在可接受范围内
- 缓存机制有效减少重复查询
- 支持大量任务的高效处理

---

## Phase 3: 前端状态同步重构
**优先级**: High  
**预估时间**: 10-12 小时  
**状态**: 待开始

### P3-T001: Zustand Store 持久化改进
**描述**: 重构 Zustand store 的持久化策略  
**优先级**: Critical  
**预估时间**: 3-4 小时  
**依赖**: P2-T001

**子任务**:
- [ ] 修改 `frontend/src/store/appStore.ts` 持久化配置
- [ ] 移除不可序列化字段 (`original_file`, `original_file_url`)
- [ ] 实现自定义序列化和反序列化逻辑
- [ ] 添加数据版本控制和迁移

**验收标准**:
- Store 能够正确持久化和恢复
- 不包含不可序列化的数据
- 数据迁移机制正常工作

### P3-T002: 状态同步机制实现
**描述**: 实现前端与后端的状态同步  
**优先级**: Critical  
**预估时间**: 4 小时  
**依赖**: P3-T001, P2-T001

**子任务**:
- [ ] 创建 `frontend/src/utils/syncManager.ts` 同步管理器
- [ ] 实现页面加载时的状态同步
- [ ] 添加状态差异检测和合并逻辑
- [ ] 实现同步状态指示器

**验收标准**:
- 页面刷新后状态能正确同步
- 状态冲突能被正确处理
- 用户能看到同步进度

### P3-T003: 文件预览重构
**描述**: 重构文件预览功能不依赖本地 File 对象  
**优先级**: High  
**预估时间**: 2-3 小时  
**依赖**: P2-T002

**子任务**:
- [ ] 修改 `frontend/src/components/FilePreview.tsx`
- [ ] 实现通过 API 获取文件预览
- [ ] 添加文件预览缓存机制
- [ ] 优化文件加载和错误处理

**验收标准**:
- 文件预览不依赖本地文件对象
- 预览加载速度可接受
- 错误情况处理得当

### P3-T004: 任务状态恢复逻辑
**描述**: 实现任务处理状态的智能恢复  
**优先级**: High  
**预估时间**: 1-2 小时  
**依赖**: P3-T002

**子任务**:
- [ ] 恢复处理中任务的轮询机制
- [ ] 重新计算和显示处理时间
- [ ] 恢复页数和进度信息显示
- [ ] 处理任务状态不一致情况

**验收标准**:
- 处理中任务能继续显示实时状态
- 计时器显示正确的处理时间
- 页数信息正确恢复

---

## Phase 4: 用户体验优化
**优先级**: Medium  
**预估时间**: 6-8 小时  
**状态**: 待开始

### P4-T001: 计时器和页数信息恢复
**描述**: 完善 TaskList 组件的状态恢复逻辑  
**优先级**: Medium  
**预估时间**: 2-3 小时  
**依赖**: P3-T004

**子任务**:
- [ ] 修改 `frontend/src/components/TaskList.tsx` 初始化逻辑
- [ ] 基于服务器时间戳重新计算处理时间
- [ ] 恢复 PDF 页数信息显示
- [ ] 优化计时器状态管理

**验收标准**:
- 页面刷新后计时器显示正确时间
- PDF 页数信息正确显示
- 所有任务状态信息完整

### P4-T002: 同步状态指示器
**描述**: 添加数据同步过程的用户反馈  
**优先级**: Medium  
**预估时间**: 1-2 小时  
**依赖**: P3-T002

**子任务**:
- [ ] 设计同步状态 UI 组件
- [ ] 添加同步进度指示器
- [ ] 实现同步错误提示
- [ ] 优化同步过程的用户体验

**验收标准**:
- 用户能清楚看到同步状态
- 同步错误有明确提示
- 同步过程不影响正常使用

### P4-T003: 错误处理和降级体验
**描述**: 完善错误处理和离线功能  
**优先级**: Medium  
**预估时间**: 2 小时  
**依赖**: P3-T002

**子任务**:
- [ ] 实现网络连接检测
- [ ] 添加离线模式提示
- [ ] 优化错误信息显示
- [ ] 实现数据恢复重试机制

**验收标准**:
- 网络问题时有合适的提示
- 离线状态下基本功能可用
- 错误恢复机制正常工作

### P4-T004: 性能优化和测试
**描述**: 优化整体性能和用户体验  
**优先级**: Medium  
**预估时间**: 1-2 小时  
**依赖**: P4-T001, P4-T002, P4-T003

**子任务**:
- [ ] 优化组件渲染性能
- [ ] 实现智能缓存策略
- [ ] 添加加载状态优化
- [ ] 进行端到端测试

**验收标准**:
- 页面响应速度快
- 内存使用合理
- 各种场景测试通过

---

## Phase 5: 测试和部署
**优先级**: Medium  
**预估时间**: 4-6 小时  
**状态**: 待开始

### P5-T001: 集成测试
**描述**: 进行完整的功能集成测试  
**优先级**: High  
**预估时间**: 2-3 小时  
**依赖**: P4-T004

**子任务**:
- [ ] 测试服务器重启后的状态恢复
- [ ] 测试页面刷新后的功能完整性
- [ ] 测试各种网络异常情况
- [ ] 测试大量任务时的性能表现

**验收标准**:
- 所有核心功能正常工作
- 异常情况处理得当
- 性能满足要求

### P5-T002: 数据迁移和兼容性
**描述**: 处理现有数据的迁移和向后兼容  
**优先级**: Medium  
**预估时间**: 1-2 小时  
**依赖**: P5-T001

**子任务**:
- [ ] 创建数据迁移脚本
- [ ] 处理旧版本数据格式
- [ ] 验证数据迁移完整性
- [ ] 添加版本兼容性检查

**验收标准**:
- 现有数据能正确迁移
- 版本升级不影响功能
- 数据完整性得到保证

### P5-T003: 文档和部署准备
**描述**: 完善文档和部署配置  
**优先级**: Low  
**预估时间**: 1 小时  
**依赖**: P5-T002

**子任务**:
- [ ] 更新 README.md 和 CLAUDE.md
- [ ] 添加新功能使用说明
- [ ] 优化部署配置
- [ ] 创建故障排除指南

**验收标准**:
- 文档完整且易懂
- 部署过程简单明确
- 包含常见问题解决方案

---

## 总体时间估算
- **Phase 1**: 12-16 小时 (Critical)
- **Phase 2**: 8-10 小时 (High)  
- **Phase 3**: 10-12 小时 (High)
- **Phase 4**: 6-8 小时 (Medium)
- **Phase 5**: 4-6 小时 (Medium)

**总计**: 40-52 小时

## 里程碑检查点

### Milestone 1: 后端持久化完成 (Phase 1)
- 服务器重启后任务状态不丢失
- 文件存储结构优化完成
- 基础持久化机制验证通过

### Milestone 2: API 服务完善 (Phase 2)  
- 状态同步 API 可用
- 文件预览服务正常
- 性能满足基本要求

### Milestone 3: 前端同步实现 (Phase 3)
- 页面刷新后状态正确恢复  
- 文件预览功能不依赖本地文件
- 状态同步机制稳定工作

### Milestone 4: 用户体验优化 (Phase 4)
- 所有UI状态正确显示
- 错误处理机制完善
- 用户反馈及时准确

### Final Release: 功能完整发布 (Phase 5)
- 完整功能测试通过
- 数据迁移方案验证
- 文档和部署准备就绪

---

## 风险评估和缓解

### 高风险项
1. **数据迁移风险**: 现有任务数据可能丢失
   - **缓解**: 详细测试，数据备份，分步迁移

2. **性能影响**: 文件操作可能影响API性能
   - **缓解**: 异步处理，缓存机制，性能监控

3. **状态同步复杂性**: 前后端状态同步逻辑复杂
   - **缓解**: 简化设计，充分测试，错误恢复

### 中风险项
1. **用户体验中断**: 改进过程中可能影响现有功能
   - **缓解**: 分阶段部署，向后兼容，功能开关

2. **文件存储空间**: 保留原始文件可能占用更多空间
   - **缓解**: 文件清理机制，存储监控，压缩优化

## 成功标准

### 功能性标准
- ✅ 服务器重启后任务列表完整保留
- ✅ 页面刷新后所有状态信息正确显示  
- ✅ 文件预览功能在各种情况下正常工作
- ✅ 计时器和页数信息持续显示

### 性能标准  
- ✅ 页面加载时间 < 3 秒
- ✅ 状态同步时间 < 2 秒
- ✅ API 响应时间 < 500ms
- ✅ 内存使用增长 < 20%

### 用户体验标准
- ✅ 数据恢复过程对用户透明
- ✅ 错误情况有清晰的反馈
- ✅ 所有现有功能保持不变
- ✅ 新功能学习成本为零